---
title: "Grade Calculator"
author: "Vincent Quenneville-BÃ©lair"
date: "February 5, 2016"
runtime: shiny
output: html_document
---

```{r echo=FALSE, message=FALSE}
library(knitr)
```

`r opts_chunk$set(echo=FALSE, message=FALSE)`

The goal is to compute the final score of each student. We need to open the required spreadsheets, tidy and manipulate the data, and finally compute the weighted score.
```{r}
# install.packages(c("tidyr", "dplyr")
# install.packages(c("xlsx", "readODS"))

library(xlsx)
library(readODS)

library(stringr)
library(tidyr)
library(dplyr)
```

## Loading and cleaning the data

We load the first spreadsheet, and modify the ID command to get a number.
```{r}
# Load spreadsheet
sec12 <- read.xlsx("data/Fall 2015 Lab 120, Sec 1L12.xlsx", sheetName = "Sheet1", rowIndex = -c(1:7), colIndex = c(1:15))
# summary(sec12)

# Assign the correct labels
names(sec12) <- names(sec12) %>% str_replace("\\.{1,}", " ") %>% str_to_title()
names(sec12)[1] <- "ID"
names(sec12)[7] <- "Lab 6"

# Removing entries without IDs
sec12 <- sec12[complete.cases(sec12[,1]),]

# Clean IDs
sec12 <- sec12 %>%
  mutate(ID = str_replace_all(ID, "s", "")) %>%
  mutate(ID = str_replace_all(ID, " ", "")) %>%
  mutate(ID = str_replace_all(ID, "S", ""))

sec12$ID <- as.integer(sec12$ID)

head(sec12)
```

##

We now read the second spreadsheet, and do similar conversions.
```{r}
# Load spreadsheet
sec09 <- read.ods("data/Fall 2015 Lab 120 section 1L09.ods", sheet = 1)
sec09 <- sec09[9:28,1:15]

# Assign the correct labels
names(sec09) <- names(sec12)

# Clean IDs
sec09 <- sec09 %>%
  mutate(ID = str_replace_all(ID, "s", "")) %>%
  mutate(ID = str_replace_all(ID, " ", "")) %>%
  mutate(ID = str_replace_all(ID, "S", ""))

# Convert to numeric data type
sec09 <- sapply(sec09, as.numeric)
sec09 <- as.data.frame(sec09)
sec09$ID <- as.integer(sec09$ID)

head(sec09)
```

##

We finally read the third spreadsheet.
```{r}
# Load spreadsheet
lec <- read.xlsx("data/lecture.xlsx", sheetName = "Sheet1", colIndex = c(2:5))
labels <- c("ID", "Midterm 1", "Midterm 2", "Final 1")
names(lec) <- labels

# Clean IDs
lec <- lec %>%
  mutate(ID = str_replace_all(ID, "s", "")) %>%
  mutate(ID = str_replace_all(ID, " ", "")) %>%
  mutate(ID = str_replace_all(ID, "S", ""))

head(lec)
```

##

We then merge the two sections, and merge with lecture data.
```{r}
data <- rbind(sec09, sec12)
data <- merge(data, lec, by="ID", all = TRUE)
```

We scale the two quiz columns to 100.
```{r}
data$`Quiz 1` = data$`Quiz 1`/20*100
data$`Quiz 2` = data$`Quiz 2`/20*100

# Backup original dataset
data.original <- data
```

```{r}
head(data)
```

## Tidying the data

We tidy the data, and make the data frame narrow and long.
```{r}
data <- data %>% 
  gather(key = "Type", value = "Score", -ID) %>%
  separate(col = "Type", into = c("Type", "TypeNumber")) 

# Convert to numerics
data$TypeNumber <- as.integer(data$TypeNumber)

# Backup tidy data
data.tidy <- data

# Remove not necessary column
data <- select(data, -`TypeNumber`)

# Look at data
head(data)
```

We now treat all the missing scores in types other than labs as 0.
```{r}
r <- data$Type != "Lab"
c <- "Score"
data[r, c][is.na(data[r, c])] <- 0
```

## Computing the weigthed score

We drop the two lowest labs.
```{r}
data <- data %>%
  group_by(ID, Type) %>%
  mutate(RankedScore = rank(Score, na.last = FALSE, ties.method = "first")) %>%
  filter((RankedScore > 2 & Type == "Lab") | (Type !="Lab")) %>%  # Drop two lowest labs
  select(-`RankedScore`)

data.bestlabs <- data
```
If there are NAs still assigned for labs, the student did not complete enough labs.

We make the weighted sum of the two midterms. We also take the mean per ID and Type.
```{r}
weighted_minmax <- function(x){
  .20/.55 * min(x) + .35/.55 * max(x)
}

data[data$Type == "Midterm",] <- data[data$Type == "Midterm",] %>% 
  group_by(ID, Type) %>% 
  mutate(Score = weighted_minmax(Score))
  
# Take mean per ID and Type
data <- data %>% 
  group_by(ID, Type) %>% 
  summarise_each(funs(mean))
```

We now scale each score to its corresponding weight in the final score.
```{r}
data[data$Type == "Lab",] <- data[data$Type == "Lab",] %>% 
  group_by(ID, Type) %>% 
  mutate(Score = .8 * .15 * Score)

data[data$Type == "Quiz",] <- data[data$Type == "Quiz",] %>% 
  group_by(ID, Type) %>% 
  mutate(Score = .2 * .15 * Score)

data[data$Type == "Midterm",] <- data[data$Type == "Midterm",] %>% 
  group_by(ID, Type) %>% 
  mutate(Score = .55 * .85 * Score)
  
data[data$Type == "Final",] <- data[data$Type == "Final",] %>% 
  group_by(ID, Type) %>% 
  mutate(Score = .45 * .85 * Score)
```

We can now simply sum per ID to get the final scores.
```{r}
data <- data %>% 
  select(-Type) %>%
  group_by(ID) %>% 
  summarise_each(funs(sum))
```

If the score is NA, the student did not do enough lab to pass the course.
```{r}
data[is.na(data)] <- 0

# Backup final course scores
data.course <- data
```

Merge the final course score in the tidy table.
```{r}
data$Type <- "Course"
data$TypeNumber <- 1
data <- rbind(data.tidy, data)
```
##

We save data frame to CSV.
```{r}
head(data)

write.csv(data, "course.csv")
```

# Gradebook

We display the table interactively.
```{r}
library(shiny)

# Define the interface

fluidRow(
  column(2, 
         selectInput("ID", "ID:", c("All", unique(as.character(data$ID))))
         ),
  column(2, 
         selectInput("Type", "Type:", c("All", unique(as.character(data$Type))))
         )
)

DT::renderDataTable(DT::datatable({
    data <- read.csv("course.csv")
    data$X <- NULL
    if (input$ID != "All") {
      data <- data[data$ID == input$ID,]
    }
    if (input$Type != "All") {
      data <- data[data$Type == input$Type,]
    }
    data
  }, rownames = FALSE))
```